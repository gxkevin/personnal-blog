<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>同源策略 | 李斌 Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.235e9f47.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.c767e7d4.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.2d10be97.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/22.d10b5a58.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.56d88f95.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.c6178770.js"><link rel="prefetch" href="/vuepress-blog/assets/js/12.701ab363.js"><link rel="prefetch" href="/vuepress-blog/assets/js/13.8d0b9623.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.9c3f78d8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.460d7e6c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.474d60b7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.2bc2ec19.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.a32be7da.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.c73eb15d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.bed14e33.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.82d52ce4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.7c7c5ad1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.2e43e933.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.9ec803b1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.7d5f245c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.a4522073.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.b1e57bd3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/7.22bd9833.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.e9e3ce9b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.73b9c7be.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.235e9f47.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">李斌 Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vuepress-blog/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="https://github.com/LiMiu331" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee/limiu331/readbook.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  读书笔记
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vuepress-blog/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="https://github.com/LiMiu331" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee/limiu331/readbook.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  读书笔记
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>同源策略</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/web/js-kuayu.html#同源策略" class="sidebar-link">同源策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog/web/js-kuayu.html#一个源的定义" class="sidebar-link">一个源的定义</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/web/js-kuayu.html#为什么要有这个策略？" class="sidebar-link">为什么要有这个策略？</a></li></ul></li><li><a href="/vuepress-blog/web/js-kuayu.html#跨域" class="sidebar-link">跨域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-blog/web/js-kuayu.html#jsonp（投机取巧）" class="sidebar-link">JSONP（投机取巧）</a></li><li class="sidebar-sub-header"><a href="/vuepress-blog/web/js-kuayu.html#cors跨域" class="sidebar-link">CORS跨域</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h2> <p>在了解跨域之前，我们先来看看<code>同源策略</code>这个知识</p> <h3 id="一个源的定义"><a href="#一个源的定义" class="header-anchor">#</a> 一个源的定义</h3> <p>如果两个页面的<code>协议</code>，<code>端口</code>和<code>域名</code>都相同，那么这两个页面就具有相同的源。 举个例子：</p> <p>下面的表相对http://www.bb.com 进行<code>同源检测</code>。</p> <table><thead><tr><th style="text-align:left;">url</th> <th style="text-align:left;">结果</th> <th style="text-align:left;">原因</th></tr></thead> <tbody><tr><td style="text-align:left;">http://www.bb.com/a.html</td> <td style="text-align:left;">成功</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">http://www.bb.com/a/c/d.html</td> <td style="text-align:left;">成功</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">https://www.bb.com/a/c/d.html</td> <td style="text-align:left;">失败</td> <td style="text-align:left;">不同协议(<code>https</code>和<code>http</code>)</td></tr> <tr><td style="text-align:left;">http://www.bb.com:520/a/c/d.html</td> <td style="text-align:left;">失败</td> <td style="text-align:left;">不同端口(<code>80</code>和<code>520</code>)</td></tr> <tr><td style="text-align:left;">http://www.cc.com/a/c/d.html</td> <td style="text-align:left;">失败</td> <td style="text-align:left;">不同域名(<code>bb</code>和<code>cc</code>)</td></tr></tbody></table> <h3 id="为什么要有这个策略？"><a href="#为什么要有这个策略？" class="header-anchor">#</a> 为什么要有这个策略？</h3> <p>这个策略是一个浏览器的<code>安全功能</code>。不同源不能够互相读写对方资源。 为了保护用户的信息安全，隔离潜在的恶意文件。所以有了这个策略。 你想想，如果别人的网站可以请求到你的网站的用户数据，是不是挺可怕的。一个莫名其妙的网站就可以随意请求别人的数据。这对于互联网来说，简直就是一场灾难。</p> <h2 id="跨域"><a href="#跨域" class="header-anchor">#</a> 跨域</h2> <p>好的我们大概了解了浏览器的同源策略，知道这个策略是为了保护我们的互联网世界。</p> <p>刚开始的时候，因为浏览器有这个同源策略，所以人们为了跨域获取资源，得用一些比较非常规的办法。</p> <h3 id="jsonp（投机取巧）"><a href="#jsonp（投机取巧）" class="header-anchor">#</a> JSONP（投机取巧）</h3> <p><code>HTML</code>中 <code>script</code> 标签可以加载其他域下的<code>js</code>，比如我们经常引入其他域下线上<code>cdn</code>的<code>jQuery</code>。 人们就想利用这个特性来实现从其他域下获取数据。</p> <p>我们比如说要获取另外一个网站的数据。</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;script src=&quot;api.bb.com/data...&quot;&gt;&lt;/script&gt;
复制代码
</code></pre></div><p>这时候会向<code>data</code>接口发送请求获取数据，获取数据后作为<code>js</code>来执行，那么获取到的数据是<code>JSON</code>，直接作为<code>JS</code>运行我怎么拿到里面的<code>数据</code>呢？</p> <p>这样我们就需要<code>后端</code>进行配合了。</p> <p>之前后端返回的数据:</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;name:&quot;bibi&quot;,&quot;city&quot;:&quot;hangzhou&quot;}
</code></pre></div><p>现在后端返回的数据:</p> <div class="language- extra-class"><pre class="language-text"><code>showData({&quot;name:&quot;bibi&quot;,&quot;city&quot;:&quot;hangzhou&quot;})
</code></pre></div><p>这样前端在<code>script</code>标签加载数据后，将这个数据作为<code>js</code>来执行，实际上就相当于调用了<code>showData</code>这个函数。</p> <p>我们只需要提前在页面定义好<code>showData</code>这个<code>全局函数</code>，在函数内部处理<code>参数</code>即可。</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;script&gt;
function showData(ret){
console.log(ret);
}
&lt;script src=&quot;api.bb.com/data...&quot;&gt;&lt;/script&gt;
复制代码
</code></pre></div><h4 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h4> <ul><li>兼容IE</li></ul> <h4 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h4> <ul><li>需要前后端<code>配合</code></li> <li>只支持<code>GET</code></li></ul> <p>这就是通过JSONP跨域。</p> <p>人们一直使用这种办法：直到W3C出了一个标准－CORS－&quot;<code>跨域资源共享</code>&quot;（Cross-origin resource sharing）。它允许浏览器向跨源服务器，发出<code>XMLHttpRequest</code>请求，从而克服了<code>AJAX只能同源使用的限制</code>。</p> <h3 id="cors跨域"><a href="#cors跨域" class="header-anchor">#</a> CORS跨域</h3> <p>跨域资源共享（ CORS ）机制允许 Web 应用服务器进行跨域访问控制，从而使跨域数据传输得以安全进行。</p> <p>CORS通信与同源的AJAX通信<code>没有差别</code>，代码完全一样。</p> <p>我们只需要在响应头里加上 <code>xx.com</code> 可以访问就可以了。</p> <p>实现CORS通信的<code>关键</code>是服务器。只要<code>服务器</code>实现了CORS接口，就可以<code>跨源通信</code>。</p> <h4 id="cors的两种请求"><a href="#cors的两种请求" class="header-anchor">#</a> cors的两种请求</h4> <p>浏览器将CORS请求分成两类：<code>简单请求（simple request）和非简单请求（not-so-simple request）</code>。</p> <h5 id="简单请求（simple-request）"><a href="#简单请求（simple-request）" class="header-anchor">#</a> 简单请求（simple request）</h5> <p>只要同时满足以下两大条件，就属于简单请求。</p> <blockquote><p>请求方法是以下三种方法之一：</p></blockquote> <ul><li><code>HEAD</code></li> <li><code>GET</code></li> <li><code>POST</code></li></ul> <blockquote><p>HTTP的头信息不超出以下几种字段：</p></blockquote> <ul><li><code>Accept</code></li> <li><code>Accept-Language</code></li> <li><code>Content-Language</code></li> <li><code>Last-Event-ID</code></li> <li>Content-Type：只限于三个值<code>application/x-www-form-urlencoded</code>、<code>multipart/form-data</code>、<code>text/plain</code></li></ul> <p>简单请求，就是在头信息中，增加一个<code>Origin字段</code>。 比如下面是一个跨域的<code>AJAX</code>请求，自动在头信息中，添加了一个<code>Origin</code>字段。</p> <div class="language- extra-class"><pre class="language-text"><code>GET /cors HTTP/1.1
Origin: http://api.bb.com
Host: api.alice.com
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
复制代码
</code></pre></div><p><code>Origin</code>用来告诉服务器，本次请求来自哪个源（<code>协议</code> + <code>域名</code> + <code>端口</code>）。服务器根据这个值，决定是否同意这次请求。</p> <p>如果服务器并不接受这个源，浏览器发现回应的信息头中没有<code>Access-Control-Allow-Origin</code>,就知道这是无效请求，并且抛出错误。</p> <p>注意：种错误无法通过状态码识别，因为<code>HTTP</code>回应的状态码有可能是<code>200</code>。</p> <p>如果这次请求被同意了，服务器就会返回下面的响应。</p> <div class="language- extra-class"><pre class="language-text"><code>Access-Control-Allow-Origin: http://api.bob.com
Access-Control-Allow-Credentials: true
Access-Control-Expose-Headers: FooBar
Content-Type: text/html; charset=utf-8
复制代码
</code></pre></div><p>上面的头信息中，三个都以<code>Access-Control-</code>开头。</p> <ul><li><code>Access-Control-Allow-Origin</code>：该字段是必须的。它的值要么是请求时<code>Origin</code>字段的值，要么是一个`*``，表示接受任意域名的请求。</li> <li><code>Access-Control-Allow-Credentials</code>:该字段可选。它的值是一个布尔值，表示是否允许发送<code>Cookie</code>。默认情况下，<code>Cookie</code>不包括在<code>CORS</code>请求之中。设为<code>true</code>，即表示服务器明确许可，<code>Cookie</code>可以包含在请求中，一起发给服务器。这个值也只能设为<code>true</code>，如果服务器不要浏览器发送<code>Cookie</code>，删除该字段即可。</li> <li><code>Access-Control-Expose-Headers</code>:该字段可选。<code>CORS</code>请求时，<code>XMLHttpRequest</code>对象的<code>getResponseHeader()</code>方法只能拿到6个基本字段：<code>Cache-Control</code>、<code>Content-Language</code>、<code>Content-Type</code>、<code>Expires</code>、<code>Last-Modified、Pragma</code>。如果想拿到其他字段，就必须在<code>Access-Control-Expose-Headers</code>里面指定。上面的例子指定，<code>getResponseHeader('FooBar')</code>可以返回<code>FooBar</code>字段的值。</li></ul> <h5 id="非简单请求（复杂请求）"><a href="#非简单请求（复杂请求）" class="header-anchor">#</a> 非简单请求（复杂请求）</h5> <p>非简单请求是那种对服务器有特殊要求的请求，比如请求方法是<code>PUT</code>或<code>DELETE</code>，或者<code>Content-Type</code>字段的类型是<code>application/json</code>。</p> <p>非简单请求的<code>CORS</code>请求，会在正式通信之前，增加一次<code>HTTP</code>查询请求，称为&quot;预检&quot;请求（preflight）。</p> <p>浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些<code>HTTP动词</code>和<code>头信息字段</code>。只有得到肯定答复，浏览器才会发出正式的<code>XMLHttpRequest</code>请求，否则就报错。</p> <div class="language- extra-class"><pre class="language-text"><code>var url = 'http://api.bibi.com/cors';
var xhr = new XMLHttpRequest();
xhr.open('PUT', url, true);
xhr.setRequestHeader('X-Custom-Header', 'value');
xhr.send();
复制代码
</code></pre></div><p>这个请求就是一个复杂请求，当浏览器发现这是复杂请求后，就会向服务器发送预检请求，询问服务器是否允许本次请求。</p> <p>服务器收到&quot;预检&quot;请求以后，检查了<code>Origin、Access-Control-Request-Method</code>和<code>Access-Control-Request-Headers</code>字段以后，确认允许跨源请求，就可以做出回应。</p> <div class="language- extra-class"><pre class="language-text"><code>HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 01:15:39 GMT
Server: Apache/2.0.61 (Unix)
Access-Control-Allow-Origin: http://api.bibi.com
Access-Control-Allow-Methods: GET, POST, PUT
Access-Control-Allow-Headers: X-Custom-Header
Content-Type: text/html; charset=utf-8
Content-Encoding: gzip
Content-Length: 0
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
Content-Type: text/plain
复制代码
</code></pre></div><p>面的<code>HTTP</code>回应中，关键的是<code>Access-Control-Allow-Origin</code>字段，表示<code>http://api.bibi.com</code>可以请求数据。该字段也可以设为星号，表示同意任意跨源请求。</p> <p>如果服务器拒绝预检请求，控制台就会报错。</p> <div class="language- extra-class"><pre class="language-text"><code>XMLHttpRequest cannot load http://api.cc.com.
Origin http://api.bibi.com is not allowed by Access-Control-Allow-Origin.
复制代码
</code></pre></div><p>CORS缺点：不支持IE8/9，如果要在IE8/9使用<code>CORS</code>跨域需要使用<code>XDomainRequest</code>对象来支持<code>CORS</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-blog/assets/js/app.c767e7d4.js" defer></script><script src="/vuepress-blog/assets/js/2.2d10be97.js" defer></script><script src="/vuepress-blog/assets/js/22.d10b5a58.js" defer></script>
  </body>
</html>
